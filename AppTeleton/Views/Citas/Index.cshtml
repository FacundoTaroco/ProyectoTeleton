@model AppTeleton.Models.CitasViewModel;
@{
    ViewData["Title"] = "Index";
    string tipoUsuario = Context.Session.GetString("TIPO");
    string usuario = Context.Session.GetString("USR");
}
@{
    if (ViewBag.Mensaje != null)
    {
        if (ViewBag.TipoMensaje == "ERROR")
        {
            <div class="alert alert-danger" role="alert">@ViewBag.Mensaje</div>
        }
        else if (ViewBag.TipoMensaje == "EXITO")
        {
            <div class="alert alert-success" role="alert">@ViewBag.Mensaje</div>
        }

    }
}

<h1>Citas</h1>


@{
    if (tipoUsuario == "PACIENTE")
    {

        if (ViewBag.Encuestar != null)
        {
            if (ViewBag.Encuestar == "si")
            {
                <div class="alert alert-success" role="alert">
                <p>¿Desea realizar una encuesta sobre el servicio ofrecido el dia de hoy?</p>
                    <form asp-controller="Encuesta" asp-action="Create" method="get">
                        <input type="hidden" value="@usuario" name="nombreUsuario">
                        <input type="submit" value="Si, realizar encuesta">
                    </form>
                    <form asp-controller="Encuesta" asp-action="NoCrear" method="post">
                        <input type="hidden" value="@usuario" name="nombreUsuario">
                        <input type="submit" value="No gracias">
                    </form>
                </div>
            }
        }

    <form id="formularioAbrirNotificaciones" asp-controller="Paciente" asp-action="NotificacionesPaciente" style="display:none;" method="get">
    </form>
    <h1>Index</h1>

if (Model.Notificacion != null)
{
    <p>Notificacion mas reciente</p>
    <div id="divNotificacionMasReciente" class="container alert alert-dark" role="alert" style="">
        <div class="row">
            <p class="col-8">@Model.Notificacion.Titulo</p>
            <p class="col-4">@Model.Notificacion.fecha</p>
            <p class="col-12">@Model.Notificacion.Mensaje</p>
        </div>
    </div>
}
else
{

    <div id="divNotificacionMasReciente" style="display:none;">
    </div>
}
    }
}


@if (ViewBag.TipoUsuario == "RECEPCIONISTA" || ViewBag.TipoUsuario == "ADMIN"){

<div id="filterBlock">
    <form id="filtro" asp-action="IndexFiltro" asp-controller="Citas">
        <label for="nombreFiltro">Búsqueda por Nombre</label>
        <input id="nombreFiltro" name="nombre" type="text" placeholder="Ingrese el nombre...">

        <label for="fechaFiltroInicio">Fecha de Inicio: </label>
        <input id="fechaFiltroInicio" name="fechaInicio" placeholder="DD/MM/YYYY HH:MM">

        <label for="fechaFiltroInicio">Fecha de Fin: </label>
        <input id="fechaFiltroFin" name="fechaFin" placeholder="DD/MM/YYYY HH:MM">

        <button class="btn btn-primary btn-block" type="submit">Buscar</button>
    </form>
     <form asp-action="Index" asp-controller="Citas">
            <button class="btn btn-primary btn-block" type="submit">Citas de hoy</button>
     </form>
</div>
}

<table class="table">
    <thead>
        <tr>

            @if (ViewBag.TipoUsuario == "RECEPCIONISTA" || ViewBag.TipoUsuario == "ADMIN")
                {
            <th>
                Cedula
            </th>
            <th>
                Nombre
            </th>
                }
            <th>
                Servicio
            </th>
            <th>
                Fecha
            </th>
            <th>
                Hora
            </th>
            <th>
                Tratamiento
            </th>
            <th>
                Consultorio
            </th>
             @if (ViewBag.TipoUsuario == "RECEPCIONISTA" || ViewBag.TipoUsuario == "ADMIN")
            {
                <th>
                    Estado
            </th>
            }
            <th>


            </th>

        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.citas)
        {
            <tr>
                @if (ViewBag.TipoUsuario == "RECEPCIONISTA" || ViewBag.TipoUsuario == "ADMIN")
                {
                <td>
                    @Html.DisplayFor(modelItem => item.Cedula)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.NombreCompleto)
                </td>
                }
                <td>
                    @Html.DisplayFor(modelItem => item.Servicio)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Fecha)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.HoraInicio)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Tratamiento)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Consultorio)
                </td>
                @if (ViewBag.TipoUsuario == "RECEPCIONISTA" || ViewBag.TipoUsuario == "ADMIN")
                {
                    
                <td id="tdEstado_@item.PkAgenda">
                    @if (item.Estado == "RCP")
                    {

                        <p>Recepcionado</p>

                    }
                    else
                    {

                        <p>NO recepcionado</p>

                    }
                </td>
                
                
                }
                <td>
                    @Html.ActionLink("Detalles", "Detalles", new { pkAgenda = item.PkAgenda })

                </td>
                

            </tr>
        }
    </tbody>
</table>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="~/js/signalr/dist/browser/signalr.js"></script>
<script src="~/js/ActualizarListadoCitas.js"></script>

<script>
    flatpickr("#fechaFiltroInicio", {
        dateFormat: "d/m/Y H:i",
        enableTime: false
    });

    flatpickr("#fechaFiltroFin", {
        dateFormat: "d/m/Y H:i",
        enableTime: false
    });
</script>

@if (tipoUsuario == "PACIENTE")
{
    

    <script>

        

        document.querySelector("#divNotificacionMasReciente").addEventListener("click", function (e) {

            let form = document.querySelector("#formularioAbrirNotificaciones")
            form.submit();
        })
    </script>

}